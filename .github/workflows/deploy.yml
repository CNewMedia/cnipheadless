name: Deploy to Fly (bru)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 0) Secrets check – faalt met duidelijke foutmelding als iets ontbreekt
      - name: Verify required secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          STORYBLOK_TOKEN: ${{ secrets.STORYBLOK_TOKEN }}
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "::error:: Missing FLY_API_TOKEN secret"; exit 1; fi
          if [ -z "$STORYBLOK_TOKEN" ]; then
            echo "::error:: Missing STORYBLOK_TOKEN secret"; exit 1; fi
          echo "✅ Secrets present"

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      # 1) Auth & account sanity check (maakt fout zichtbaar als token niet werkt)
      - name: Fly auth & app check
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          set -e
          flyctl auth token || true
          echo "flyctl version:"
          flyctl version
          echo "Apps visible to this token:"
          flyctl apps list | sed -n '1,30p'
          echo "Info for app cnipheadless:"
          flyctl status -a
